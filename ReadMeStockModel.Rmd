---
title: "Stock Model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Goal
The goal is to predict the performance of a given stock from financial information available in the past. The model attempts to predict the performance using a time horizon of 15 months. The model has been run the first week of October 2016. The figure of merit used to predict the performance is *actual.win.loss =  (current stock price - stock price 15 months ago)/(stock price 15 months ago)*.

## Data
The model is built using with the financial information available until June 30, 2015 (this date is referred to as end.model.date). It uses 2 years of historical stock price per month. The price at end.model.date divided by the lowest and highest stock prices during those two years are variables of the model. Information is downloaded from the web from [yahoo](https://finance.yahoo.com/) and [google](https://www.google.com/finance?ei=5xv9V_DjGMnKmAG_kJBg) finance. It uses packages quantmod and PerformanceAnalytics.

```{}
# Obtaining historical stock price data
    SYMB_prices <- get.hist.quote(instrument=stock, quote="AdjClose",provider="yahoo", compression="m", retclass="zoo", quiet=TRUE)
```

```{}
# Obtaining stock financial info
    FinStock <- getFinancials(stock, auto.assign = FALSE)
```

All the stocks available in yahoo finance are tentatively used in the model preparation and prediction. The implementation of which information is available online is based on <https://github.com/mkfs> and from functions written by me. 

There are 2755 companies that have all the information required in the model. 

Companies like *brgo* have what it seems wrong information. The price was that high only for a couple of days. Another example is *mspc* that has information that is different from what the yahoo website has. It there something wrong with some of these ultra cheap stocks?
There are 18 companies that have a price less than 1 cent during the two years prior to the end model date (*brgo* and *mspc* among them). Those companies were not taken into account when constructing the model. 

## Code
The financial information is saved locally since it is time consuming to access websites every time the model is run, and because google asks for user input (captcha screen) if running the script. The main file is StockModel.R. The file names describes what each file does. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(diagram))
# http://artax.karlin.mff.cuni.cz/r-help/library/diagram/html/plotmat.html
names <- c("Download.R", "SymbolBySector.R", "Saved data", "StockModel.R", "PrepareStockModel.R", "PrepareTable.R", "StockInfo.R")
M <- matrix(nrow = 7, ncol = 7, byrow = TRUE, data = 0)
curves <- matrix(nrow = 7, ncol = 7, data = 0)
M[1,2] <- "listAll"
M[3,1] <- "save_data"
M[4,1] <- "StockInfo"
M[4,5] <- "prepare.model()"
curves[4, 5] <- -0.8
M[4,6] <- "prepare.table()"
curves[4, 6] <- 0.3
M[6,7] <- "add.stock.to.table()"
curves[6, 7] <- -0.8
M[7,4] <- "StockInfo"
curves[7,4] <- 0.4
M[7,3] <- "Read_data"
plotmat(M, pos = c(2, 1, 4), name = names, lwd = 2, box.lwd = 2, cex.txt = 0.7, curve = curves,
        box.size = 0.13, box.type = "square", box.prop = 0.3, relsize = 0.9, box.cex = 0.7, my = 0.17,
         main = "Stock model files")
```

## Model and Results
***
The final model used is a *gbm* model[^1] with the following variables:
```{}
  my_model <- train(
    actual.win.loss ~ Price.Model.end.low.ratio + Price.Model.end.high.ratio + Price.Model.end + Assets +
      Ev.earning + Ev.ebitda + Ev.book + Ev.revenue + Ev.cash + Price.equity.debt +
      predicted.win.loss + predictedLB.win.loss + SectorIndustry.Num, 
    method ="gbm", data = my_train, train.fraction = 0.5)
```
[^1]: The method does not work correctly if train.fraction is not defined explicitely. 

I played with varying the variables and I noticed that the variable __Price.Category__ is used incorrectly by *caret* and/or *gbm*. __Price.Category__ is a factor that has 4 levels according to the stock price at the end model date (<1$, 1$-10$, 10$-100$, >100$). The final model was incorrectly only assigning 3 *categories* (same as levels?). I could not make it work. Furthermore, those categories were not relevant in the final model. Therefore, I removed __Price.Category__ and used __Price.Model.end__ instead. 

The following results are obtained:
```{}
my_model$results
  shrinkage interaction.depth n.minobsinnode n.trees     RMSE   Rsquared   RMSESD RsquaredSD
1       0.1                 1             10      50 55.61951 0.03728869 4.898717 0.02112640
```

The train data prediction compated to the actual return (in percentage) looks reasonable. Not only for the highest performers but also for the laggarts. The validation data also seems decent

![](Figures/GBM.png)

but there is a problem. These are the best 10 results in the validation data:
```{r echo=FALSE, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(googleVis))
```
```{r results='asis', echo=FALSE}
load(file = "~/Dropbox/Courses/R/Finance/Figures/Res_val.Rda")
tab1 <- gvisTable(head(res_val, 10))
print(tab1, "chart")
```
All of the top results are from __SectorIndustry.Num__ 134 (Gold). The important parameters in the model are in the following table. All other variables are not relevant (rel.inf = 0). __SectorIndustry.Num__ 133 is Industrial Metals & Minerals.

```{r echo=FALSE, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(googleVis))
```
```{r results='asis', echo=FALSE}
load(file = "~/Dropbox/Courses/R/Finance/Figures/imp_par.Rda")
tab1 <- gvisTable(head(imp_par, 13))
print(tab1, "chart")
```

If those industries are removed from the final results (but still keeping them in the model), the model results are much worse

![](Figures/GBM_no134-133.png)

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Stock Model</title>

<script src="ReadMeStockModel_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="ReadMeStockModel_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="ReadMeStockModel_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="ReadMeStockModel_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="ReadMeStockModel_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="ReadMeStockModel_files/navigation-1.1/tabsets.js"></script>
<link href="ReadMeStockModel_files/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="ReadMeStockModel_files/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Stock Model</h1>

</div>


<div id="goal" class="section level1">
<h1>Goal</h1>
<p>The goal is to predict the performance of a given stock from financial information available in the past. The model attempts to predict the performance using a fixed time horizon. The figure of merit used to predict the performance is <em>actual.win.loss = (stock price at prediction date - stock price by end of model date)/(stock price by end of model date)</em>.</p>
</div>
<div id="data" class="section level1">
<h1>Data</h1>
<p>The model is built using with financial information available on the web. The final date used in the model is referred to as end.model.date (it corresponds to stock price by end of model date). It uses 2 years of historical stock price to construct the model. The price at end.model.date divided by the lowest and highest stock prices during those two years are variables of the model. Information is downloaded from <a href="https://finance.yahoo.com/">yahoo</a> and <a href="https://www.google.com/finance?ei=5xv9V_DjGMnKmAG_kJBg">google</a> finance. It uses packages quantmod and PerformanceAnalytics.</p>
<pre><code># Obtaining historical stock price data
    SYMB_prices &lt;- get.hist.quote(instrument=stock, quote=&quot;AdjClose&quot;,provider=&quot;yahoo&quot;, compression=&quot;m&quot;, retclass=&quot;zoo&quot;, quiet=TRUE)</code></pre>
<pre><code># Obtaining stock financial info
    FinStock &lt;- getFinancials(stock, auto.assign = FALSE)</code></pre>
<p>Almost all stocks available in yahoo finance are used in the model preparation and prediction. Downloading of available information is is based on <a href="https://github.com/mkfs" class="uri">https://github.com/mkfs</a> and from functions written by <a href="https://github.com/Fernando-Montes/Finance">me</a>.</p>
<p>There are about 2750 companies that have all the information required in the model.</p>
<p>Companies like <em>brgo</em> have what it seems wrong information since the price is unrealistically high for a couple of days and suddenly decreases to normal values. Another example is <em>mspc</em> that has information that is different from what the yahoo website has. It there something wrong with some of these ultra cheap stocks? There are 18 companies that have a price less than 1 cent during the two years prior to the end model date (<em>brgo</em> and <em>mspc</em> among them). Those companies were not taken into account when constructing the model. <strong>Update August 2017:</strong> Only companies that have a stock price greater than $5 and belong to the Nasdaq or NYSE stock exchanges are included.</p>
</div>
<div id="code" class="section level1">
<h1>Code</h1>
<p>The financial information is saved locally since it is time consuming to access websites every time the model is run, and because google asks for user input (captcha screen) if running the script. The main file is StockModel.R. The file names describes what each file does.</p>
<p><img src="ReadMeStockModel_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
</div>
<div id="model-and-results" class="section level1">
<h1>Model and Results</h1>
<div id="attempts-1-10" class="section level2">
<h2>Attempts 1-10:</h2>
<p>The model was constructed using the following variables:</p>
<table>
<colgroup>
<col width="20%" />
<col width="79%" />
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Price.Model.end.low.ratio</td>
<td>Stock price / lowest stock price during the last 2 years</td>
</tr>
<tr class="even">
<td>Price.Model.end.high.ratio</td>
<td>Stock price / highest stock price during the last 2 years</td>
</tr>
<tr class="odd">
<td>Price.Model.end</td>
<td>Stock price</td>
</tr>
<tr class="even">
<td>Assets</td>
<td>Total assets</td>
</tr>
<tr class="odd">
<td>Ev.earning</td>
<td>Enterprise value / earnings</td>
</tr>
<tr class="even">
<td>Ev.ebitda</td>
<td>Enterprise value / EBITDA (earnings before interests, taxes, depreciation, amortization and unusual expenses)</td>
</tr>
<tr class="odd">
<td>Ev.book</td>
<td>Enterprise value / book value</td>
</tr>
<tr class="even">
<td>Ev.revenue</td>
<td>Enterprise value / revenue</td>
</tr>
<tr class="odd">
<td>Ev.cash</td>
<td>Enterprise value / cash</td>
</tr>
<tr class="even">
<td>Price.equity.debt</td>
<td>Stock price /(Total equity/ Total debt)</td>
</tr>
<tr class="odd">
<td>predicted.win.loss</td>
<td>Predicted performance using a Holt-Winters model of the stock price</td>
</tr>
<tr class="even">
<td>predictedLB.win.loss</td>
<td>Predicted lower bound performance using a Holt-Winters model of the stock price</td>
</tr>
<tr class="odd">
<td>SectorIndustry.Num</td>
<td>Sector-industry number the stock belongs to</td>
</tr>
</tbody>
</table>
<p>The actual model construction<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>:</p>
<pre><code>   my_model &lt;- train(
    actual.win.loss ~ Price.Model.end.low.ratio + Price.Model.end.high.ratio + Price.Model.end + Assets +
      Ev.earning + Ev.ebitda + Ev.book + Ev.revenue + Ev.cash + Price.equity.debt +
      predicted.win.loss + predictedLB.win.loss + SectorIndustry.Num, 
    method =&quot;gbm&quot;, data = my_train, train.fraction = 0.5, tuneLength = 10,  #mtry can change from 1 to tuneLength
    trControl = trainControl(method = &quot;cv&quot;, number = 5, repeats = 10, verboseIter = TRUE)
    )</code></pre>
<p>I played with varying the variables and I noticed that some variables are used incorrectly by <em>caret</em> and/or <em>gbm</em>. Using a factor that has 4 levels according to the stock price at the end model date (&lt;1, 1-10, 10-100, &gt;100) did not work. The final model was incorrectly only assigning 3 <em>categories</em> (same as levels?) and I could not make it work. Furthermore, those categories were not relevant in the final model. Therefore, I decided to use <strong>Price.Model.end</strong> instead.</p>
<p>The time horizon used in the following is 15 months in the future (from the data financial information is last available). The model was prepared with data from 2013/06/03 to 2015/06/30 for a prediction at 2016/09/30. The following results are obtained:</p>
<pre><code>my_model$results
    shrinkage interaction.depth n.minobsinnode n.trees     RMSE   Rsquared    RMSESD  RsquaredSD
1         0.1                 1             10      50 58.57166 0.04230435 10.026998 0.042328721</code></pre>
<p>Calculating the RMSE directly in the train and validation data sets result in 57.4 and 54.5 respectively. The same for method <span class="math inline">\(ranger\)</span> results in 30.4 and 54.3. The RMSE results for method <span class="math inline">\(glmnet\)</span> are 57.3 and 50. The problem with <span class="math inline">\(glmnet\)</span> is that variable <strong>SectorIndustry.Num</strong> is the most relevant variable by a large margin. All other variables seem to be irrelevant. Is this a problem with the method or with the way the model is built? By selecting the <span class="math inline">\(gbm\)</span> method, more variables matter. The important variables in <span class="math inline">\(gbm\)</span> are in the following table.</p>
<!-- Table generated in R 3.3.2 by googleVis 0.6.2 package -->
<!-- Mon Nov 20 15:52:53 2017 -->
<!-- jsHeader -->
<script type="text/javascript">
 
// jsData 
function gvisDataTableID43c779d97000 () {
var data = new google.visualization.DataTable();
var datajson =
[
 [
"SectorIndustry.Num134",
29.76021963
],
[
"Price.Model.end.high.ratio",
23.80213048
],
[
"Ev.revenue",
11.17564829
],
[
"predicted.win.loss",
8.484423223
],
[
"Price.Model.end",
5.514723066
],
[
"Ev.cash",
5.455602343
],
[
"Assets",
4.456982792
],
[
"SectorIndustry.Num133",
3.956282445
],
[
"Ev.book",
2.382580942
],
[
"Ev.earning",
1.931493247
],
[
"predictedLB.win.loss",
1.087784194
],
[
"Ev.ebitda",
1.020041704
],
[
"Price.equity.debt",
0.972087644
] 
];
data.addColumn('string','var');
data.addColumn('number','rel.inf');
data.addRows(datajson);
return(data);
}
 
// jsDrawChart
function drawChartTableID43c779d97000() {
var data = gvisDataTableID43c779d97000();
var options = {};
options["allowHtml"] = true;

    var chart = new google.visualization.Table(
    document.getElementById('TableID43c779d97000')
    );
    chart.draw(data,options);
    

}
  
 
// jsDisplayChart
(function() {
var pkgs = window.__gvisPackages = window.__gvisPackages || [];
var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
var chartid = "table";
  
// Manually see if chartid is in pkgs (not all browsers support Array.indexOf)
var i, newPackage = true;
for (i = 0; newPackage && i < pkgs.length; i++) {
if (pkgs[i] === chartid)
newPackage = false;
}
if (newPackage)
  pkgs.push(chartid);
  
// Add the drawChart function to the global list of callbacks
callbacks.push(drawChartTableID43c779d97000);
})();
function displayChartTableID43c779d97000() {
  var pkgs = window.__gvisPackages = window.__gvisPackages || [];
  var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
  window.clearTimeout(window.__gvisLoad);
  // The timeout is set to 100 because otherwise the container div we are
  // targeting might not be part of the document yet
  window.__gvisLoad = setTimeout(function() {
  var pkgCount = pkgs.length;
  google.load("visualization", "1", { packages:pkgs, callback: function() {
  if (pkgCount != pkgs.length) {
  // Race condition where another setTimeout call snuck in after us; if
  // that call added a package, we must not shift its callback
  return;
}
while (callbacks.length > 0)
callbacks.shift()();
} });
}, 100);
}
 
// jsFooter
</script>
<!-- jsChart -->
<script type="text/javascript" src="https://www.google.com/jsapi?callback=displayChartTableID43c779d97000"></script>
<!-- divChart -->
<div id="TableID43c779d97000" style="width: 500; height: automatic;">

</div>
<p>All other variables are not relevant (rel.inf = 0). <strong>SectorIndustry.Num</strong> 134 and 133 are Gold and Industrial Metals &amp; Minerals, respectively. The train data prediction compated to the actual return (in percentage) looks reasonable. Not only for the highest performers but also for the laggarts. The validation data also seems decent</p>
<div class="figure">
<img src="Figures/GBM.png" />

</div>
<p>but there is a problem. These are the best 10 results in the validation data:</p>
<!-- Table generated in R 3.3.2 by googleVis 0.6.2 package -->
<!-- Mon Nov 20 15:52:53 2017 -->
<!-- jsHeader -->
<script type="text/javascript">
 
// jsData 
function gvisDataTableID43c74ca1dd69 () {
var data = new google.visualization.DataTable();
var datajson =
[
 [
"goro",
5.25,
2.149824,
7.839369,
2.149824,
"2",
112.75,
107.4912,
99.55338831,
1.231262836,
5.005477624,
5.541268521,
0.0361334055,
4.609798172,
-19.11833416,
"134",
1,
0.2742343166,
144.2060373,
114.4267704,
-989.2976428,
91.92387046
],
[
"ora.to",
0.17,
0.08,
0.19,
0.08,
"1",
166.17,
-8,
-10.10725664,
0.3623477157,
0.5913124515,
4.954967462,
0.02791878173,
-0.007876290735,
-273.5865487,
"134",
1,
0.4210526316,
112.5,
-109.8453634,
-342083.1858,
84.91237586
],
[
"mmy.v",
0.11,
0.09,
0.34,
0.09,
"1",
262.51,
9,
9.598618421,
0.1210127317,
2.813866924,
0.9858040541,
0.0001455646332,
0.1141094967,
-244.9169167,
"134",
1,
0.2647058824,
22.22222222,
26.78832968,
-272229.9075,
80.03390172
],
[
"ngd.to",
5.14,
2.89,
7.46,
2.89,
"2",
3910.5,
-41.28571429,
18.52985013,
0.651004469,
4.370974747,
4.50205049,
1.124414602,
3.251208366,
-46.22327196,
"134",
1,
0.3873994638,
77.85467128,
12.49855937,
-1699.421175,
79.87213718
],
[
"ric",
8.43,
1,
3.52,
2.63,
"2",
191.95,
52.6,
41.58553134,
0.9988147906,
3.763721332,
1.958410112,
0.149572644,
2.4100212,
-17.96087945,
"134",
2.63,
0.7471590909,
220.5323194,
-8.364212935,
-782.9231729,
79.64038075
],
[
"grc.v",
0.21,
0.345953,
0.775248,
0.738471,
"1",
60.23,
73.8471,
111.9294814,
1.65915993,
41.57380738,
3.569880418,
0.2601910365,
0.5584040767,
-63.38087795,
"134",
2.134599209,
0.9525609869,
-71.56286435,
-24.38375011,
-8682.717256,
77.17805313
],
[
"cg.to",
6.42,
2.96488,
7.472937,
6.363673,
"2",
1692.09,
70.70747778,
68.67367008,
1.039554469,
10.25776387,
2.563349252,
0.3339934035,
7.390097596,
-103.8438199,
"134",
2.146350948,
0.8515625115,
0.8851334756,
16.12943651,
-1731.82206,
76.81539776
],
[
"dmm.to",
0.24,
0.52,
1.74,
0.52,
"1",
70.83,
-5.777777778,
-5.887786667,
0.4056439464,
4.961617978,
12.61668571,
0.06066507441,
0.3130269683,
-41.1954322,
"134",
1,
0.2988505747,
-53.84615385,
-39.80250609,
-8022.198499,
75.14076625
],
[
"aem",
44.950001,
21.859224,
37.621254,
21.859224,
"3",
6749.81,
437.18448,
26.52265547,
1.140473484,
9.300165425,
22.58776072,
6.366745905,
25.58341483,
-706.1877991,
"134",
1,
0.5810339017,
105.6340198,
17.03715936,
-3330.616965,
74.99989019
],
[
"nem",
33.970001,
17.081755,
30.734064,
17.081755,
"3",
25961,
94.89863889,
16.89178034,
0.8018013027,
4.736426878,
2.704909453,
9.673750525,
23.7548679,
-252.1979375,
"134",
1,
0.5557922636,
98.86715973,
39.06573356,
-1576.417017,
74.99989019
] 
];
data.addColumn('string','Stock.SYM');
data.addColumn('number','Price.Current');
data.addColumn('number','Price.Min');
data.addColumn('number','Price.Max');
data.addColumn('number','Price.Model.end');
data.addColumn('string','Price.Category');
data.addColumn('number','Assets');
data.addColumn('number','Ev.earning');
data.addColumn('number','Ev.ebitda');
data.addColumn('number','Ev.book');
data.addColumn('number','Ev.revenue');
data.addColumn('number','Ev.cash');
data.addColumn('number','Price.equity.debt');
data.addColumn('number','Price.Prediction');
data.addColumn('number','Price.Prediction.LB');
data.addColumn('string','SectorIndustry.Num');
data.addColumn('number','Price.Model.end.low.ratio');
data.addColumn('number','Price.Model.end.high.ratio');
data.addColumn('number','actual.win.loss');
data.addColumn('number','predicted.win.loss');
data.addColumn('number','predictedLB.win.loss');
data.addColumn('number','model_pred');
data.addRows(datajson);
return(data);
}
 
// jsDrawChart
function drawChartTableID43c74ca1dd69() {
var data = gvisDataTableID43c74ca1dd69();
var options = {};
options["allowHtml"] = true;

    var chart = new google.visualization.Table(
    document.getElementById('TableID43c74ca1dd69')
    );
    chart.draw(data,options);
    

}
  
 
// jsDisplayChart
(function() {
var pkgs = window.__gvisPackages = window.__gvisPackages || [];
var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
var chartid = "table";
  
// Manually see if chartid is in pkgs (not all browsers support Array.indexOf)
var i, newPackage = true;
for (i = 0; newPackage && i < pkgs.length; i++) {
if (pkgs[i] === chartid)
newPackage = false;
}
if (newPackage)
  pkgs.push(chartid);
  
// Add the drawChart function to the global list of callbacks
callbacks.push(drawChartTableID43c74ca1dd69);
})();
function displayChartTableID43c74ca1dd69() {
  var pkgs = window.__gvisPackages = window.__gvisPackages || [];
  var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
  window.clearTimeout(window.__gvisLoad);
  // The timeout is set to 100 because otherwise the container div we are
  // targeting might not be part of the document yet
  window.__gvisLoad = setTimeout(function() {
  var pkgCount = pkgs.length;
  google.load("visualization", "1", { packages:pkgs, callback: function() {
  if (pkgCount != pkgs.length) {
  // Race condition where another setTimeout call snuck in after us; if
  // that call added a package, we must not shift its callback
  return;
}
while (callbacks.length > 0)
callbacks.shift()();
} });
}, 100);
}
 
// jsFooter
</script>
<!-- jsChart -->
<script type="text/javascript" src="https://www.google.com/jsapi?callback=displayChartTableID43c74ca1dd69"></script>
<!-- divChart -->
<div id="TableID43c74ca1dd69" style="width: 500; height: automatic;">

</div>
<p>All of the top results are from <strong>SectorIndustry.Num</strong> 134 (Gold). If industries 134 and 133 are removed from the final results (but still keeping them in the model), the model results are much worse:</p>
<div class="figure">
<img src="Figures/GBM_no134-133.png" />

</div>
</div>
<div id="attempts-10-12" class="section level2">
<h2>Attempts 10-12:</h2>
<p>Assuming the problem with the previous attempts were the chosen variables, variables were changed. Valuations valuations of a given stock compared to other companies with the same Sector-industry-number were added:</p>
<table>
<colgroup>
<col width="20%" />
<col width="79%" />
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Ev.earning.peers</td>
<td>Enterprise value / earnings of the stock divided by its average value (stocks in the same sector-industry)</td>
</tr>
<tr class="even">
<td>Ev.ebitda.peers</td>
<td>Enterprise value / EBITDA of the stock divided by its average value (stocks in the same sector-industry)</td>
</tr>
<tr class="odd">
<td>Ev.book.peers</td>
<td>Enterprise value / book value of the stock divided by its average value (stocks in the same sector-industry)</td>
</tr>
<tr class="even">
<td>Ev.revenue.peers</td>
<td>Enterprise value / revenueof the stock divided by its average value (stocks in the same sector-industry)</td>
</tr>
<tr class="odd">
<td>Ev.cash.peers</td>
<td>Enterprise value / cash of the stock divided by its average value (stocks in the same sector-industry)</td>
</tr>
<tr class="even">
<td>Price.equity.debt.peers</td>
<td>Stock price /(Total equity/ Total debt) of the stock divided by its average value (stocks in the same sector-industry)</td>
</tr>
</tbody>
</table>
<p>The variable <strong>SectorIndustry.Num</strong> was removed since the sector performance over model training period is taken into account and it is likely that that performance will not be repeated in the future.</p>
<p>The variables importance in a <span class="math inline">\(gbm\)</span> model are in the following table:</p>
<!-- Table generated in R 3.3.2 by googleVis 0.6.2 package -->
<!-- Mon Nov 20 15:52:53 2017 -->
<!-- jsHeader -->
<script type="text/javascript">
 
// jsData 
function gvisDataTableID43c715ed96f6 () {
var data = new google.visualization.DataTable();
var datajson =
[
 [
"Price.Model.end.high.ratio",
21.3518907
],
[
"predicted.win.loss",
13.17831143
],
[
"Price.Model.end",
12.58687093
],
[
"Ev.revenue",
7.634509135
],
[
"Ev.cash.peers",
5.444282989
],
[
"Ev.ebitda",
5.278781082
],
[
"Ev.book.peers",
5.256853741
],
[
"Ev.book",
4.869078573
],
[
"Price.equity.debt",
4.532309664
],
[
"Price.Model.end.low.ratio",
3.964346969
],
[
"Assets",
3.397256038
],
[
"Ev.revenue.peers",
2.954587674
],
[
"Price.equity.debt.peers",
2.366455656
] 
];
data.addColumn('string','var');
data.addColumn('number','rel.inf');
data.addRows(datajson);
return(data);
}
 
// jsDrawChart
function drawChartTableID43c715ed96f6() {
var data = gvisDataTableID43c715ed96f6();
var options = {};
options["allowHtml"] = true;

    var chart = new google.visualization.Table(
    document.getElementById('TableID43c715ed96f6')
    );
    chart.draw(data,options);
    

}
  
 
// jsDisplayChart
(function() {
var pkgs = window.__gvisPackages = window.__gvisPackages || [];
var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
var chartid = "table";
  
// Manually see if chartid is in pkgs (not all browsers support Array.indexOf)
var i, newPackage = true;
for (i = 0; newPackage && i < pkgs.length; i++) {
if (pkgs[i] === chartid)
newPackage = false;
}
if (newPackage)
  pkgs.push(chartid);
  
// Add the drawChart function to the global list of callbacks
callbacks.push(drawChartTableID43c715ed96f6);
})();
function displayChartTableID43c715ed96f6() {
  var pkgs = window.__gvisPackages = window.__gvisPackages || [];
  var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
  window.clearTimeout(window.__gvisLoad);
  // The timeout is set to 100 because otherwise the container div we are
  // targeting might not be part of the document yet
  window.__gvisLoad = setTimeout(function() {
  var pkgCount = pkgs.length;
  google.load("visualization", "1", { packages:pkgs, callback: function() {
  if (pkgCount != pkgs.length) {
  // Race condition where another setTimeout call snuck in after us; if
  // that call added a package, we must not shift its callback
  return;
}
while (callbacks.length > 0)
callbacks.shift()();
} });
}, 100);
}
 
// jsFooter
</script>
<!-- jsChart -->
<script type="text/javascript" src="https://www.google.com/jsapi?callback=displayChartTableID43c715ed96f6"></script>
<!-- divChart -->
<div id="TableID43c715ed96f6" style="width: 500; height: automatic;">

</div>
<p>Calculating the RMSE directly in the train and validation data sets result in 56.1 and 59.4 respectively. Those numbers are slightly worse than during attempts 1-10 but the results and the relative importance of the variables look better.</p>
<div class="figure">
<img src="Figures/GBM_model2.png" />

</div>
<p>The random forest model <span class="math inline">\(ranger\)</span> results in 26.9 and 57.6 for the RMSE in train and validation data respectively:</p>
<div class="figure">
<img src="Figures/ranger_model2.png" />

</div>
<p>The linear regression model <span class="math inline">\(glmnet\)</span> performs badly and results in an RMSE in the validation data larger than a 100.</p>
</div>
<div id="attempts-12-15" class="section level2">
<h2>Attempts 12-15:</h2>
<p>Changes from previous attempts:</p>
<ul>
<li>Variables added:
<ul>
<li>Simple moving average variable (over 200 days) and comparison with its peers.</li>
<li>Simple moving average variable (over 50 days) and comparison with its peers.</li>
<li>ARIMA forecast prediction.</li>
<li>Relative Strength Index RSI over 10 days: it expresses the fraction of gains and losses over the past lookback periods, 100 - (100/(1 + RS)), where RS is the average gain over the average loss over the lookback window decided.</li>
<li>Relative Strength Index RSI over 50 days.</li>
<li>Value representing the percentage rank of the stock price between the lowest and highest stock price during the last 2 years.</li>
</ul></li>
<li>Changed varibles calculating the stock price over the lowest (and highest) stock price during the last 2 years to a calculation that uses daily stock prices instead of monthly stock prices.</li>
<li>Corrections:
<ul>
<li>Holt-Winters prediction and its lower bound with 90% confidence were calculated with a time horizon incorrectly calculated (it was 1 month too long).</li>
<li>Stock price at end.model.date was incorrectly taken one month later. This affected all variables involving this price.</li>
</ul></li>
</ul>
<p>In the previous attempts and these ones too, the calculated RMEs are highly variable depending on the splitting between training and testing data. This observation is independent of the method used:</p>
<div class="figure">
<img src="Figures/ranger_gbm.png" />

</div>
<p>The relative importance of the variables also changes but not as much (most of the time). This is a particular example for the <span class="math inline">\(ranger\)</span> method:</p>
<div class="figure">
<img src="Figures/ranger3_varImp.png" />

</div>
<p>The train data is over-fitted with the <span class="math inline">\(ranger\)</span> method but the validation data modeling is not worse than using the <span class="math inline">\(gbm\)</span> (or any other method) method. One of the main takeaways so far is that despite adding more and more variables, the effectiveness of the model, as measured by the RMS value, has not improved much from the first attempts.</p>
</div>
<div id="changing-time-horizon" class="section level2">
<h2>Changing time horizon:</h2>
<p>Using a time horizon of 3 months, the results get better:</p>
<div class="figure">
<img src="Figures/ranger_gbm_timeHorizon3.png" />

</div>
<p>The relative importance of the different variables also change. Enterprise value (stock price * number of shares) variables become more relevant.</p>
<div class="figure">
<img src="Figures/ranger4_varImp.png" />

</div>
<p>For the <span class="math inline">\(gbm\)</span> method, this is what the predictions look like:</p>
<div class="figure">
<img src="Figures/GBM_timeHorizon3.png" />

</div>
</div>
<div id="eliminating-quaterly-variables-assets-equity-etc." class="section level2">
<h2>Eliminating quaterly variables (assets, equity, etc.):</h2>
<p>By leaving only stock price variables and eliminating all quaterly variables the RMS results do not change dramatically:</p>
<div class="figure">
<img src="Figures/ranger_gbm_timeHorizon3_redVar.png" />

</div>
<p>For the <span class="math inline">\(gbm\)</span> method, this is what the predictions look like:</p>
<div class="figure">
<img src="Figures/GBM_timeHorizon3_redVar.png" />

</div>
</div>
<div id="robustness-of-the-model" class="section level2">
<h2>Robustness of the model:</h2>
<p>This is how the ranking of predictions compare between methods <span class="math inline">\(gbm\)</span> and <span class="math inline">\(ranger\)</span>:</p>
<div class="figure">
<img src="Figures/ranger_gbm_robust_3.png" />

</div>
<p>Notice how there are some companies that have a high rank in one of the methods but not in both. There are also some companies highly ranked in both methods. The colors indicate the ranking based on actual/win losses. Notice that there are more high ranking (high gains) companies in the top right corner than in the bottom left corner. However, the correlation between model ranking and actual win/loss ranking is not great:</p>
<div class="figure">
<img src="Figures/ranger_actual_robust_3.png" />

</div>
<p>The last figure should show a linear correlation if the model were perfect. As it, there is still a lot of room for improvement. Adding quaterly variables does not improve the figure much. Therefore they are removed again for the following results.</p>
<div class="figure">
<img src="Figures/ranger_actual_robust_3_quaterly.png" />

</div>
<p>The correlation between results using <span class="math inline">\(glmnet\)</span> and <span class="math inline">\(ranger\)</span> is not as clean, but that could actually be better since companies with high rankings in both methods also seem to have good rankings in the actual win/loss ranking.</p>
<div class="figure">
<img src="Figures/ranger_glmnet_robust_3.png" />

</div>
<p>I also tested the robustness of using the <span class="math inline">\(ranger\)</span> method using different train data. The resulting graph is very similar to the one comparing different methods.</p>
<p>Requiring a rank in methods <span class="math inline">\(ranger\)</span>, <span class="math inline">\(gbm\)</span> and <span class="math inline">\(glmnet\)</span> above 90%, the following companies are the ones recommended by the model (prepared with data from 2013/06/03 to 2015/06/30 for a prediction at 2015/09/30):</p>
<!-- Table generated in R 3.3.2 by googleVis 0.6.2 package -->
<!-- Mon Nov 20 15:52:53 2017 -->
<!-- jsHeader -->
<script type="text/javascript">
 
// jsData 
function gvisDataTableID43c7723de708 () {
var data = new google.visualization.DataTable();
var datajson =
[
 [
"msex",
92.27941176,
87.00980392,
91.42156863,
88.1127451,
6.580328492
],
[
"it",
92.89215686,
91.66666667,
91.78921569,
76.10294118,
-2.156678738
] 
];
data.addColumn('string','Stock.SYM');
data.addColumn('number','rank_ranger');
data.addColumn('number','rank_gbm');
data.addColumn('number','rank_glmnet');
data.addColumn('number','rank_actual');
data.addColumn('number','actual.win.loss');
data.addRows(datajson);
return(data);
}
 
// jsDrawChart
function drawChartTableID43c7723de708() {
var data = gvisDataTableID43c7723de708();
var options = {};
options["allowHtml"] = true;

    var chart = new google.visualization.Table(
    document.getElementById('TableID43c7723de708')
    );
    chart.draw(data,options);
    

}
  
 
// jsDisplayChart
(function() {
var pkgs = window.__gvisPackages = window.__gvisPackages || [];
var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
var chartid = "table";
  
// Manually see if chartid is in pkgs (not all browsers support Array.indexOf)
var i, newPackage = true;
for (i = 0; newPackage && i < pkgs.length; i++) {
if (pkgs[i] === chartid)
newPackage = false;
}
if (newPackage)
  pkgs.push(chartid);
  
// Add the drawChart function to the global list of callbacks
callbacks.push(drawChartTableID43c7723de708);
})();
function displayChartTableID43c7723de708() {
  var pkgs = window.__gvisPackages = window.__gvisPackages || [];
  var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
  window.clearTimeout(window.__gvisLoad);
  // The timeout is set to 100 because otherwise the container div we are
  // targeting might not be part of the document yet
  window.__gvisLoad = setTimeout(function() {
  var pkgCount = pkgs.length;
  google.load("visualization", "1", { packages:pkgs, callback: function() {
  if (pkgCount != pkgs.length) {
  // Race condition where another setTimeout call snuck in after us; if
  // that call added a package, we must not shift its callback
  return;
}
while (callbacks.length > 0)
callbacks.shift()();
} });
}, 100);
}
 
// jsFooter
</script>
<!-- jsChart -->
<script type="text/javascript" src="https://www.google.com/jsapi?callback=displayChartTableID43c7723de708"></script>
<!-- divChart -->
<div id="TableID43c7723de708" style="width: 500; height: automatic;">

</div>
<p>Using the same model but for data from 2013/09/03 to 2015/09/30 for a prediction at 2015/12/31 results in RMS of 34 for <span class="math inline">\(ranger\)</span> and <span class="math inline">\(gbm\)</span> methods. Method <span class="math inline">\(glmnet\)</span> has an outlier that makes the RMS blow up. These are the companies with the highest actual ranking and their method rankings:</p>
<!-- Table generated in R 3.3.2 by googleVis 0.6.2 package -->
<!-- Mon Nov 20 15:52:53 2017 -->
<!-- jsHeader -->
<script type="text/javascript">
 
// jsData 
function gvisDataTableID43c76abc91d3 () {
var data = new google.visualization.DataTable();
var datajson =
[
 [
"pli.to",
38.03907114,
35.16402506,
39.7714707,
99.66826391,
128.5714286
],
[
"lm.v",
46.81164762,
48.72834501,
87.91006266,
99.70512348,
144.7368421
],
[
"adat",
41.39329156,
36.56468854,
8.551419093,
99.74198304,
144.8275994
],
[
"zyxi",
51.71396978,
68.74308883,
39.69775157,
99.77884261,
150
],
[
"cylu",
98.08330262,
68.00589753,
0.8846295614,
99.81570217,
200
],
[
"erii",
9.62034648,
12.45853299,
15.11242167,
99.85256174,
230.3738318
],
[
"lei",
27.5340951,
15.66531515,
1.990416513,
99.8894213,
239.5348837
],
[
"pacb",
15.22300037,
22.85293034,
27.4235164,
99.92628087,
258.7431694
],
[
"linc",
77.51566532,
29.67194987,
3.28050129,
99.96314043,
290.1960784
],
[
"dpdm",
25.69111684,
23.99557685,
12.08993734,
100,
566.6666667
] 
];
data.addColumn('string','Stock.SYM');
data.addColumn('number','rank_ranger');
data.addColumn('number','rank_gbm');
data.addColumn('number','rank_glmnet');
data.addColumn('number','rank_actual');
data.addColumn('number','actual.win.loss');
data.addRows(datajson);
return(data);
}
 
// jsDrawChart
function drawChartTableID43c76abc91d3() {
var data = gvisDataTableID43c76abc91d3();
var options = {};
options["allowHtml"] = true;

    var chart = new google.visualization.Table(
    document.getElementById('TableID43c76abc91d3')
    );
    chart.draw(data,options);
    

}
  
 
// jsDisplayChart
(function() {
var pkgs = window.__gvisPackages = window.__gvisPackages || [];
var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
var chartid = "table";
  
// Manually see if chartid is in pkgs (not all browsers support Array.indexOf)
var i, newPackage = true;
for (i = 0; newPackage && i < pkgs.length; i++) {
if (pkgs[i] === chartid)
newPackage = false;
}
if (newPackage)
  pkgs.push(chartid);
  
// Add the drawChart function to the global list of callbacks
callbacks.push(drawChartTableID43c76abc91d3);
})();
function displayChartTableID43c76abc91d3() {
  var pkgs = window.__gvisPackages = window.__gvisPackages || [];
  var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
  window.clearTimeout(window.__gvisLoad);
  // The timeout is set to 100 because otherwise the container div we are
  // targeting might not be part of the document yet
  window.__gvisLoad = setTimeout(function() {
  var pkgCount = pkgs.length;
  google.load("visualization", "1", { packages:pkgs, callback: function() {
  if (pkgCount != pkgs.length) {
  // Race condition where another setTimeout call snuck in after us; if
  // that call added a package, we must not shift its callback
  return;
}
while (callbacks.length > 0)
callbacks.shift()();
} });
}, 100);
}
 
// jsFooter
</script>
<!-- jsChart -->
<script type="text/javascript" src="https://www.google.com/jsapi?callback=displayChartTableID43c76abc91d3"></script>
<!-- divChart -->
<div id="TableID43c76abc91d3" style="width: 500; height: automatic;">

</div>
<p>None of the methods is particularly good. It seems that the assumption that a model created and optimized at an earlier time (3 months in this case) is not completely valid by the time it has to be used. However some of the model is still useful. Requiring an average rank in methods <span class="math inline">\(ranger\)</span>, <span class="math inline">\(gbm\)</span> and <span class="math inline">\(glmnet\)</span> above 95.5%, results in companies:</p>
<!-- Table generated in R 3.3.2 by googleVis 0.6.2 package -->
<!-- Mon Nov 20 15:52:53 2017 -->
<!-- jsHeader -->
<script type="text/javascript">
 
// jsData 
function gvisDataTableID43c75a4cf6f4 () {
var data = new google.visualization.DataTable();
var datajson =
[
 [
"vnr.to",
96.01916697,
93.58643568,
97.89900479,
71.32325839,
9.811697384
],
[
"nen",
96.24032436,
98.5256174,
91.92775525,
65.75746406,
7.257599249
],
[
"t.to",
96.35090306,
96.79321784,
94.47106524,
29.56137118,
-8.020416479
],
[
"ecl",
97.41983045,
98.4150387,
90.85882787,
59.6019167,
4.562771654
],
[
"chd",
98.48875783,
98.37817914,
92.77552525,
50.60818282,
1.577989645
],
[
"ari",
99.41024696,
96.05602654,
92.81238481,
77.36822705,
12.5731695
] 
];
data.addColumn('string','Stock.SYM');
data.addColumn('number','rank_ranger');
data.addColumn('number','rank_gbm');
data.addColumn('number','rank_glmnet');
data.addColumn('number','rank_actual');
data.addColumn('number','actual.win.loss');
data.addRows(datajson);
return(data);
}
 
// jsDrawChart
function drawChartTableID43c75a4cf6f4() {
var data = gvisDataTableID43c75a4cf6f4();
var options = {};
options["allowHtml"] = true;

    var chart = new google.visualization.Table(
    document.getElementById('TableID43c75a4cf6f4')
    );
    chart.draw(data,options);
    

}
  
 
// jsDisplayChart
(function() {
var pkgs = window.__gvisPackages = window.__gvisPackages || [];
var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
var chartid = "table";
  
// Manually see if chartid is in pkgs (not all browsers support Array.indexOf)
var i, newPackage = true;
for (i = 0; newPackage && i < pkgs.length; i++) {
if (pkgs[i] === chartid)
newPackage = false;
}
if (newPackage)
  pkgs.push(chartid);
  
// Add the drawChart function to the global list of callbacks
callbacks.push(drawChartTableID43c75a4cf6f4);
})();
function displayChartTableID43c75a4cf6f4() {
  var pkgs = window.__gvisPackages = window.__gvisPackages || [];
  var callbacks = window.__gvisCallbacks = window.__gvisCallbacks || [];
  window.clearTimeout(window.__gvisLoad);
  // The timeout is set to 100 because otherwise the container div we are
  // targeting might not be part of the document yet
  window.__gvisLoad = setTimeout(function() {
  var pkgCount = pkgs.length;
  google.load("visualization", "1", { packages:pkgs, callback: function() {
  if (pkgCount != pkgs.length) {
  // Race condition where another setTimeout call snuck in after us; if
  // that call added a package, we must not shift its callback
  return;
}
while (callbacks.length > 0)
callbacks.shift()();
} });
}, 100);
}
 
// jsFooter
</script>
<!-- jsChart -->
<script type="text/javascript" src="https://www.google.com/jsapi?callback=displayChartTableID43c75a4cf6f4"></script>
<!-- divChart -->
<div id="TableID43c75a4cf6f4" style="width: 500; height: automatic;">

</div>
<p>which have an average actual win loss percentage of 4.6% while the average of all the companies considered is 0.7%. When adding quaterly variables the average actual win loss percentage is 7.5%.</p>
<p>Changing the construction of the model from 2014/03/03 to 2016/03/31 and applying it to 2016/06/30, obtains an average actual win loss percentage of 22.4% for companies with a predicted average ranking of 97%, compared to 5.4% for the average for all companies. However, when using the same model for data from 2014/06/03 to 2016/06/30 for a prediction by 2016/09/30 obtains an average actual win loss percentage of -3.4% for companies with a predicted average ranking of 99%, compared to 8.7% for the average for all companies. The model does not work!</p>
<p>Tried subsetting the data to specific price categories and/or assets and the model does not seem to improve. I believe the problem is not with the existing variables but with missing information not currently in the model.</p>
<p>To be continued ….</p>
</div>
</div>
<div id="to-do" class="section level1">
<h1>To do</h1>
<ul>
<li>Add/replace variables:
<ul>
<li>Add a google trend variables (stock and sector).</li>
</ul></li>
</ul>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>The <span class="math inline">\(gbm\)</span> method does not work correctly if train.fraction is not defined explicitely.<a href="#fnref1">↩</a></p></li>
</ol>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
